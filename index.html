<!DOCTYPE html>
<html>
  <head>
    <title>Share My Location</title>
    <script>
      // Function to extract query parameters from the URL
      function getQueryParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      function sendLocation() {
        const statusElement = document.getElementById("status");
        const loaderElement = document.getElementById("loader");

        if (navigator.geolocation) {
          statusElement.innerText = "Retrieving your location...";
          loaderElement.style.display = "block";

          navigator.geolocation.getCurrentPosition(
            function (position) {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;

              if (latitude === 0 && longitude === 0) {
                alert("Error: Invalid location detected. Please try again.");
                console.error("Invalid location data: Latitude and Longitude are 0.");
                window.close();
                return;
              }

              // Make.com Webhook URL
              const webhookUrl = "https://hook.us2.make.com/2mwqx4zc6jtx9pr4ycrw9pwimsil37vo";

              // Dynamically extract user_id and type from the URL
              const userId = getQueryParameter("user_id") || "unknown";
              const type = getQueryParameter("type") || "unknown";

              console.log("Latitude:", latitude, "Longitude:", longitude, "User ID:", userId, "Type:", type);

              // Send data to the Webhook
              fetchWithTimeout(webhookUrl, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  type: type, // Include the request type
                  user_id: {userId},
                  latitude: {latitude},
                  longitude: {longitude},
                }),
              })
                .then((response) => {
                  if (response.ok) {
                    alert("Location sent successfully!");
                    window.close();
                  } else {
                    console.error("Failed to send location:", response.statusText);
                    alert("Failed to send location. Please try again.");
                  }
                })
                .catch((error) => {
                  console.error("Fetch error:", error.message);
                  alert("Error: " + error.message);
                });
            },
            function (error) {
              statusElement.innerText = "Failed to retrieve location.";
              loaderElement.style.display = "none";
              console.error("Error getting location:", error.message);
              alert(
                "Error getting location: " +
                  (error.message || "Please allow location access.")
              );
              window.close();
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
          console.error("Geolocation not supported.");
          window.close();
        }
      }

      function fetchWithTimeout(url, options, timeout = 5000) {
        return Promise.race([
          fetch(url, options),
          new Promise((_, reject) =>
            setTimeout(() => reject(new Error("Request timeout")), timeout)
          ),
        ]);
      }
    </script>
  </head>
  <body onload="sendLocation()">
    <h1 id="status">Sharing Location...</h1>
    <div id="loader" style="display: none;">‚è≥</div>
    <p>Please allow location access.</p>
  </body>
</html>
