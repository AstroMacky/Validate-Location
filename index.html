<!DOCTYPE html>
<html>
  <head>
    <title>Share My Location</title>
    <script>
      // Function to extract query parameters from the URL
      function getQueryParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      function sendLocation() {
        const statusElement = document.getElementById("status");
        const loaderElement = document.getElementById("loader");

        if (navigator.geolocation) {
          statusElement.innerText = "Retrieving your location...";
          loaderElement.style.display = "block";

          navigator.geolocation.getCurrentPosition(
            function (position) {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;

              if (latitude === 0 && longitude === 0) {
                alert("Error: Invalid location detected. Please try again.");
                console.error("Invalid location data: latitude and longitude are 0.");
                window.close();
                return;
              }

              // Replace this with your Make.com Webhook URL
              const webhookUrl = "https://hook.us2.make.com/j6q2qqw99c2dlhqfjmb16w7hajajchw7";

              // Dynamically extract user_id and type from the URL
              const userId = getQueryParameter("user_id") || "unknown";
              const type = "geolocation"; // Define the type for geolocation requests

              // Debugging logs
              console.log("Before sending to webhook:");
              console.log("latitude:", latitude, "longitude:", longitude, "User ID:", userId, "Type:", type);

              // Send the data to your webhook
              fetchWithTimeout(webhookUrl, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  type: type, // Include the request type
                  user_id: userId,
                  latitude: latitude,
                  longitude: longitude,
                }),
              })
                .then((response) => {
                  if (response.ok) {
                    alert("Location sent successfully!");
                    console.log("Webhook response: Success");
                    window.close();
                  } else {
                    console.error("Failed to send location:", response.statusText);
                    alert("Failed to send location. Please try again.");
                  }
                })
                .catch((error) => {
                  console.error("Fetch error:", error.message);
                  alert("Error: " + error.message);
                });
            },
            function (error) {
              statusElement.innerText = "Failed to retrieve location.";
              loaderElement.style.display = "none";

              // Detailed geolocation error handling
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  alert("User denied the request for Geolocation.");
                  break;
                case error.POSITION_UNAVAILABLE:
                  alert("Location information is unavailable.");
                  break;
                case error.TIMEOUT:
                  alert("The request to get user location timed out.");
                  break;
                case error.UNKNOWN_ERROR:
                  alert("An unknown error occurred.");
                  break;
              }

              console.error("Error getting location:", error.message);
              window.close();
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
          console.error("Geolocation not supported.");
          window.close();
        }
      }

      // Function to handle fetch requests with a timeout
      function fetchWithTimeout(url, options, timeout = 5000) {
        return Promise.race([
          fetch(url, options),
          new Promise((_, reject) =>
            setTimeout(() => reject(new Error("Request timeout")), timeout)
          ),
        ]);
      }
    </script>
  </head>
  <body onload="sendLocation()">
    <h1 id="status">Sharing Location...</h1>
    <div id="loader" style="display: none;">‚è≥</div>
    <p>Please allow location access.</p>
  </body>
</html>
